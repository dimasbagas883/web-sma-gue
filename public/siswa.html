<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Siswa - EduPortal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        #app-shell { display: none; }
        .nav-link.active { background-color: #eef2ff; color: #4f46e5; font-weight: 600; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app-shell" class="hidden h-screen bg-gray-100">
        <!-- Sidebar -->
        <div id="sidebar" class="w-64 bg-white shadow-lg flex-shrink-0 flex flex-col">
            <div class="p-6 border-b"><h1 class="text-2xl font-bold text-indigo-600">EduPortal</h1></div>
            <div class="p-4 border-b"><div id="user-profile-info"></div></div>
            <nav id="nav-container" class="p-4 space-y-2 flex-grow"></nav>
            <div class="p-4 border-t"><button id="logout-btn" class="w-full flex items-center px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg"><i data-lucide="log-out" class="w-5 h-5 mr-3"></i>Logout</button></div>
        </div>
        <!-- Konten Utama -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex justify-between items-center p-4 bg-white border-b"><h2 id="page-title" class="text-xl font-semibold text-gray-800">Dasbor</h2></header>
            <main id="main-content" class="flex-1 overflow-x-hidden overflow-y-auto p-6"></main>
        </div>
    </div>

<script>
    const API_URL = 'http://localhost:5000';
    const ui = {};
    let appState = { chartInstance: null };

    // =================================================================
    // ----------- RENDER FUNCTIONS (Membuat Tampilan) -----------
    // =================================================================
    const render = {
        page: (title, handler) => {
            ui.pageTitle.textContent = title;
            ui.mainContent.innerHTML = `<div id="content-wrapper" class="bg-white p-6 rounded-xl shadow-md min-h-full"></div>`;
            handler(document.getElementById('content-wrapper'));
        },
        siswaDashboard: async (container) => {
            container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6"><div class="p-6 rounded-lg border"><p class="text-sm text-gray-500">Tugas Belum Selesai</p><p id="summary-tugas" class="text-3xl font-bold">...</p></div><div class="p-6 rounded-lg border"><p class="text-sm text-gray-500">Ujian Mendatang</p><p id="summary-ujian" class="text-3xl font-bold">...</p></div><div class="p-6 rounded-lg border"><p class="text-sm text-gray-500">Persentase Kehadiran</p><p id="summary-hadir" class="text-3xl font-bold">...%</p></div></div><div class="p-6 rounded-lg border mt-6"><h3 class="font-semibold mb-4">Performa Nilai</h3><canvas id="nilaiChart"></canvas></div>`;
            const result = await apiRequest('/api/dashboard/siswa');
            if (result) {
                document.getElementById('summary-tugas').textContent = result.ringkasan.tugasBelumSelesai;
                document.getElementById('summary-ujian').textContent = result.ringkasan.ujianMendatang;
                document.getElementById('summary-hadir').textContent = `${result.ringkasan.persentaseKehadiran}%`;
                const ctx = document.getElementById('nilaiChart').getContext('2d');
                if(appState.chartInstance) appState.chartInstance.destroy();
                appState.chartInstance = new Chart(ctx, { type: 'bar', data: { labels: result.performaNilai.labels, datasets: [{ label: 'Nilai Rata-rata', data: result.performaNilai.data, backgroundColor: '#6366f1', borderRadius: 5 }] }, options: { scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } } });
            }
        },
        jadwalPelajaran: async (container) => {
            container.innerHTML = 'Memuat jadwal...';
            const result = await apiRequest('/api/jadwal/saya');
            if (!result || !result.data) { container.innerHTML = 'Gagal memuat jadwal.'; return; }
            let content = '';
            const jadwalByHari = result.data.reduce((acc, curr) => { (acc[curr.hari] = acc[curr.hari] || []).push(curr); return acc; }, {});
            ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'].forEach(hari => {
                if (jadwalByHari[hari] && jadwalByHari[hari].length > 0) {
                    content += `<h4 class="font-bold text-lg mb-2 mt-4">${hari}</h4>`;
                    jadwalByHari[hari].sort((a,b) => a.jamMulai.localeCompare(b.jamMulai)).forEach(j => { content += `<div class="p-3 border-l-4 border-indigo-500 bg-indigo-50 rounded-r-lg mb-2"><p class="font-semibold">${j.jamMulai} - ${j.jamSelesai}: ${j.mataPelajaran.namaMapel}</p><p class="text-sm text-gray-600">Guru: ${j.guru.name}</p></div>`; });
                }
            });
            container.innerHTML = content || '<p>Tidak ada jadwal ditemukan. Anda mungkin belum dimasukkan ke dalam kelas.</p>';
        },
        daftarNilai: async (container) => {
            container.innerHTML = `Memuat nilai...`;
            const result = await apiRequest('/api/penilaian/saya');
            if (!result || !result.data) { container.innerHTML = 'Gagal memuat nilai.'; return; }
            let tableHTML = `<div class="overflow-x-auto"><table class="w-full text-left"><thead><tr class="border-b"><th class="p-3">Mata Pelajaran</th><th class="p-3">Jenis Penilaian</th><th class="p-3 text-right">Nilai</th></tr></thead><tbody>`;
            result.data.forEach(n => { if(n.mataPelajaran) tableHTML += `<tr class="border-b"><td class="p-3">${n.mataPelajaran.namaMapel}</td><td class="p-3">${n.jenis}</td><td class="p-3 font-bold text-right">${n.nilai}</td></tr>`; });
            tableHTML += '</tbody></table></div>';
            container.innerHTML = result.data.length > 0 ? tableHTML : '<p>Belum ada nilai yang diinput untuk Anda.</p>';
        },
        materiPelajaran: async (container) => {
            container.innerHTML = 'Memuat materi...';
            const kelasSiswa = await apiRequest('/api/kelas/siswa/saya');
            if (!kelasSiswa || !kelasSiswa.data) { container.innerHTML = 'Anda tidak terdaftar di kelas manapun.'; return; }
            const result = await apiRequest(`/api/materi/by-kelas/${kelasSiswa.data._id}`);
            if (!result || !result.data) { container.innerHTML = 'Gagal memuat materi.'; return; }
            let content = '';
            result.data.forEach(materi => {
                content += `<div class="p-4 border rounded-lg mb-2"><h4 class="font-bold">${materi.judul}</h4><p class="text-sm text-gray-600">Mapel: ${materi.mataPelajaran.namaMapel} | Oleh: ${materi.diunggahOleh.name}</p><p class="my-2">${materi.deskripsi}</p><a href="${API_URL}${materi.pathFile}" target="_blank" class="text-indigo-600 font-semibold hover:underline">Download Materi</a></div>`;
            });
            container.innerHTML = content || '<p>Belum ada materi yang diunggah untuk kelas Anda.</p>';
        },
        daftarTugas: async (container) => {
            container.innerHTML = 'Memuat tugas...';
            const kelasSiswa = await apiRequest('/api/kelas/siswa/saya');
            if (!kelasSiswa || !kelasSiswa.data) { container.innerHTML = 'Anda tidak terdaftar di kelas manapun.'; return; }
            const result = await apiRequest(`/api/tugas/by-kelas/${kelasSiswa.data._id}`);
            if (!result || !result.data) { container.innerHTML = 'Gagal memuat tugas.'; return; }
            let content = '';
            result.data.forEach(tugas => {
                const sudahTerkumpul = tugas.sudahTerkumpul;
                const statusBadge = sudahTerkumpul ? `<span class="text-xs font-semibold px-2 py-1 bg-green-100 text-green-800 rounded-full">Sudah Dikerjakan</span>` : `<span class="text-xs font-semibold px-2 py-1 bg-blue-100 text-blue-800 rounded-full">Belum Dikerjakan</span>`;
                const formUpload = sudahTerkumpul ? `<div class="mt-4 p-3 bg-gray-100 rounded-lg text-center text-sm text-gray-600">Anda sudah mengumpulkan tugas ini.</div>` : `<form onsubmit="handle.submitTugas(event, '${tugas._id}')"><label class="block text-sm font-medium mb-1">Kumpulkan Tugas:</label><div class="flex items-center space-x-2"><input type="file" name="fileTugas" class="w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100" required><button type="submit" class="bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-semibold">Kumpul</button></div></form>`;
                content += `<div class="p-4 border rounded-lg mb-3"><div class="flex justify-between items-start"><div><h4 class="font-bold">${tugas.judul}</h4><p class="text-sm text-gray-600">Mapel: ${tugas.mataPelajaran.namaMapel} | Deadline: ${new Date(tugas.deadline).toLocaleDateString('id-ID')}</p></div>${statusBadge}</div><p class="my-2">${tugas.deskripsi}</p>${formUpload}</div>`;
            });
            container.innerHTML = content || '<p>Tidak ada tugas untuk saat ini.</p>';
        }
    };

    // =================================================================
    // ----------- HANDLER FUNCTIONS (Logika Aksi) -----------
    // =================================================================
    const handle = {
        submitTugas: async (event, tugasId) => {
            event.preventDefault();
            const form = event.target;
            const fileInput = form.querySelector('input[type="file"]');
            if (!fileInput.files[0]) {
                alert('Silakan pilih file untuk diunggah.');
                return;
            }
            const formData = new FormData();
            formData.append('fileTugas', fileInput.files[0]);
            
            const submitButton = form.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = 'Mengunggah...';

            const result = await apiRequest(`/api/tugas/${tugasId}/submit`, 'POST', formData);
            
            submitButton.disabled = false;
            submitButton.textContent = 'Kumpul';

            if(result) {
                alert('Tugas berhasil dikumpulkan!');
                render.daftarTugas(document.getElementById('content-wrapper'));
            }
        },
    };

    // =================================================================
    // --------------- INISIALISASI & LOGIKA UTAMA ------------------
    // =================================================================
    async function apiRequest(endpoint, method = 'GET', body = null) {
        const token = localStorage.getItem('token'); if (!token) { logout(); return; }
        const options = { method, headers: {} };
        if (body) {
            if (body instanceof FormData) { options.headers['Authorization'] = `Bearer ${token}`; options.body = body; }
            else { options.headers['Content-Type'] = 'application/json'; options.headers['Authorization'] = `Bearer ${token}`; options.body = JSON.stringify(body); }
        } else { options.headers['Authorization'] = `Bearer ${token}`; }
        try {
            const response = await fetch(`${API_URL}${endpoint}`, options);
            if(response.status === 401) { logout(); return; }
            const data = await response.json();
            if (!response.ok) throw new Error(data.message || 'Terjadi kesalahan');
            return data;
        } catch (error) { console.error("API Error:", error); alert(error.message); }
    }
    
    function setupUI() { const ids = ['app-shell','logout-btn','sidebar','user-profile-info','nav-container','main-content','page-title']; ids.forEach(id => { ui[id.replace(/-(\w)/g, (m, p1) => p1.toUpperCase())] = document.getElementById(id); }); }
    
    function showDashboard() {
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user || user.role !== 'siswa') { logout(); return; }
        ui.appShell.style.display = 'flex';
        renderLayout(user);
    }

    function renderLayout(user) {
        ui.userProfileInfo.innerHTML = `<div class="w-10 h-10 bg-indigo-200 rounded-full flex items-center justify-center font-bold text-indigo-700">${user.name.charAt(0)}</div><div><p class="font-semibold">${user.name}</p><p class="text-sm text-gray-500">${user.role}</p></div>`;
        const navItems = [
            { text: 'Dashboard', icon: 'layout-dashboard', handler: () => render.page('Dashboard', render.siswaDashboard) },
            { text: 'Jadwal Pelajaran', icon: 'calendar', handler: () => render.page('Jadwal Pelajaran', c => render.jadwalPelajaran(c, 'siswa')) },
            { text: 'Daftar Nilai', icon: 'award', handler: () => render.page('Daftar Nilai', render.daftarNilai) },
            { text: 'Materi Pelajaran', icon: 'book-open', handler: () => render.page('Materi Pelajaran', render.materiPelajaran) },
            { text: 'Tugas', icon: 'file-text', handler: () => render.page('Tugas', render.daftarTugas) },
        ];
        ui.navContainer.innerHTML = '';
        navItems.forEach((item, index) => {
            const link = document.createElement('a'); link.href = '#';
            link.className = 'nav-link flex items-center px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg';
            if (index === 0) link.classList.add('active');
            link.innerHTML = `<i data-lucide="${item.icon}" class="w-5 h-5 mr-3"></i><span>${item.text}</span>`;
            link.onclick = (e) => { e.preventDefault(); document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); link.classList.add('active'); item.handler(); };
            ui.navContainer.appendChild(link);
        });
        lucide.createIcons();
        if (navItems.length > 0) navItems[0].handler();
    }
    const logout = () => { localStorage.clear(); window.location.href = 'login.html'; };
    
    document.addEventListener('DOMContentLoaded', () => {
        setupUI();
        const token = localStorage.getItem('token');
        if (!token) { window.location.href = 'login.html'; return; }
        showDashboard();
        ui.logoutBtn.addEventListener('click', logout);
    });
</script>
</body>
</html>
