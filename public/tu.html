<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Tata Usaha - EduPortal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        #app-shell { display: none; }
        .nav-link.active { background-color: #eef2ff; color: #4f46e5; font-weight: 600; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; border-radius: 0.25rem; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app-shell" class="hidden h-screen bg-gray-100">
        <!-- Sidebar -->
        <div id="sidebar" class="w-64 bg-white shadow-lg flex-shrink-0 flex flex-col">
            <div class="p-6 border-b"><h1 class="text-2xl font-bold text-indigo-600">EduPortal</h1></div>
            <div class="p-4 border-b"><div id="user-profile-info"></div></div>
            <nav id="nav-container" class="p-4 space-y-2 flex-grow"></nav>
            <div class="p-4 border-t"><button id="logout-btn" class="w-full flex items-center px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg"><i data-lucide="log-out" class="w-5 h-5 mr-3"></i>Logout</button></div>
        </div>
        <!-- Konten Utama -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex justify-between items-center p-4 bg-white border-b"><h2 id="page-title" class="text-xl font-semibold text-gray-800">Administrasi</h2></header>
            <main id="main-content" class="flex-1 overflow-x-hidden overflow-y-auto p-6"></main>
        </div>
    </div>

<script>
    const API_URL = 'http://localhost:5000';
    const ui = {};

    const render = {
        page: (title, handler) => {
            ui.pageTitle.textContent = title;
            ui.mainContent.innerHTML = `<div id="content-wrapper" class="bg-white p-6 rounded-xl shadow-md min-h-full"></div>`;
            handler(document.getElementById('content-wrapper'));
        },
        manajemenPembayaran: async (container) => {
            container.innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div id="form-pembayaran-container">Memuat form...</div><div id="jenis-pembayaran-container">Memuat jenis pembayaran...</div></div>`;
            render.formPembayaran(document.getElementById('form-pembayaran-container'));
            render.manajemenJenisPembayaran(document.getElementById('jenis-pembayaran-container'));
        },
        formPembayaran: async (container) => {
            const [siswaResult, jenisResult] = await Promise.all([
                apiRequest('/api/users/by-role/siswa'),
                apiRequest('/api/jenis-pembayaran')
            ]);
            if (!siswaResult || !jenisResult) { container.innerHTML = '<p>Gagal memuat data master.</p>'; return; }
            const siswaOptions = siswaResult.data.map(s => `<option value="${s._id}">${s.name}</option>`).join('');
            const jenisOptions = jenisResult.data.map(j => `<option value="${j._id}" data-jumlah="${j.jumlah}">${j.nama} - Rp ${j.jumlah.toLocaleString('id-ID')}</option>`).join('');
            container.innerHTML = `<h3 class="font-semibold text-lg mb-4">Catat Transaksi Pembayaran</h3><form id="form-pembayaran" class="p-4 border rounded-lg bg-gray-50 space-y-4"><div><label class="text-sm font-medium">Siswa</label><select name="siswa" class="w-full p-2 border rounded mt-1" required><option value="">Pilih Siswa</option>${siswaOptions}</select></div><div><label class="text-sm font-medium">Jenis Pembayaran</label><select name="jenisPembayaran" id="pembayaran-jenis" class="w-full p-2 border rounded mt-1" required><option value="">Pilih Jenis Pembayaran</option>${jenisOptions}</select></div><div><label class="text-sm font-medium">Jumlah Bayar</label><input type="number" name="jumlahBayar" id="pembayaran-jumlah" placeholder="Jumlah yang dibayar" class="w-full p-2 border rounded mt-1" required></div><div><label class="text-sm font-medium">Status</label><select name="status" class="w-full p-2 border rounded mt-1" required><option value="LUNAS">Lunas</option><option value="CICILAN">Cicilan</option></select></div><div><label class="text-sm font-medium">Keterangan (Opsional)</label><input type="text" name="keterangan" class="w-full p-2 border rounded mt-1"></div><div><button type="submit" class="w-full bg-green-600 text-white p-2 rounded-lg font-semibold">Simpan Pembayaran</button></div></form>`;
            document.getElementById('pembayaran-jenis').addEventListener('change', (e) => { const selectedOption = e.target.options[e.target.selectedIndex]; document.getElementById('pembayaran-jumlah').value = selectedOption.dataset.jumlah || ''; });
            document.getElementById('form-pembayaran').addEventListener('submit', handle.pembayaranSubmit);
        },
        manajemenJenisPembayaran: async (container) => {
            container.innerHTML = `<h3 class="font-semibold text-lg mb-4">Manajemen Jenis Pembayaran</h3><form id="form-jenis-pembayaran" class="p-4 border rounded-lg bg-gray-50 space-y-4 mb-6"><h4 class="font-semibold">Tambah Jenis Baru</h4><div><label class="text-sm font-medium">Nama Tagihan</label><input type="text" name="nama" placeholder="e.g., SPP Agustus 2025" class="w-full p-2 border rounded mt-1" required></div><div><label class="text-sm font-medium">Jumlah Tagihan (Rp)</label><input type="number" name="jumlah" placeholder="e.g., 500000" class="w-full p-2 border rounded mt-1" required></div><div><button type="submit" class="w-full bg-blue-600 text-white p-2 rounded-lg font-semibold">Tambah Jenis</button></div></form><div id="list-jenis-pembayaran">Memuat...</div>`;
            document.getElementById('form-jenis-pembayaran').addEventListener('submit', handle.jenisPembayaranSubmit);
            handle.fetchAndDisplayJenisPembayaran();
        },
        riwayatTransaksi: async (container) => {
            container.innerHTML = 'Memuat riwayat transaksi...';
            const result = await apiRequest('/api/pembayaran');
            if (!result || !result.data) { container.innerHTML = 'Gagal memuat data.'; return; }
            let tableHTML = `<div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-gray-100 text-gray-600 uppercase"><tr><th class="p-3">Tanggal</th><th class="p-3">Siswa</th><th class="p-3">Pembayaran</th><th class="p-3 text-right">Jumlah</th><th class="p-3">Status</th><th class="p-3">Petugas</th></tr></thead><tbody class="divide-y">`;
            if (result.data.length > 0) {
                result.data.forEach(p => { tableHTML += `<tr class="hover:bg-gray-50"><td class="p-3">${new Date(p.tanggalBayar).toLocaleDateString('id-ID')}</td><td class="p-3 font-medium">${p.siswa.name}</td><td class="p-3">${p.jenisPembayaran.nama}</td><td class="p-3 text-right">Rp ${p.jumlahBayar.toLocaleString('id-ID')}</td><td class="p-3">${p.status}</td><td class="p-3">${p.dicatatOleh.name}</td></tr>`; });
            } else {
                tableHTML += `<tr><td colspan="6" class="p-4 text-center text-gray-500">Belum ada riwayat transaksi.</td></tr>`;
            }
            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;
        },
    };
    const handle = {
        fetchAndDisplayJenisPembayaran: async () => {
            const container = document.getElementById('list-jenis-pembayaran');
            container.innerHTML = 'Memuat...'; const result = await apiRequest('/api/jenis-pembayaran');
            if (!result || !result.data) { container.innerHTML = '<p>Gagal memuat data.</p>'; return; }
            let listHTML = '<div class="space-y-2 mt-4">';
            result.data.forEach(jenis => { listHTML += `<div class="p-3 border rounded flex justify-between items-center"><div><p class="font-semibold">${jenis.nama}</p><p class="text-sm text-gray-500">Rp ${jenis.jumlah.toLocaleString('id-ID')}</p></div><button class="bg-red-500 text-white btn-sm" onclick="handle.deleteJenisPembayaran('${jenis._id}')">Hapus</button></div>`; });
            listHTML += '</div>';
            container.innerHTML = listHTML || '<p>Belum ada jenis pembayaran dibuat.</p>';
        },
        jenisPembayaranSubmit: async (e) => {
            e.preventDefault(); const form = e.target;
            const body = { nama: form.nama.value, jumlah: form.jumlah.value };
            await apiRequest('/api/jenis-pembayaran', 'POST', body);
            alert('Jenis pembayaran baru berhasil dibuat!');
            form.reset(); handle.fetchAndDisplayJenisPembayaran();
            render.formPembayaran(document.getElementById('form-pembayaran-container'));
        },
        deleteJenisPembayaran: async (id) => {
            if (confirm('Yakin ingin menghapus jenis pembayaran ini?')) {
                await apiRequest(`/api/jenis-pembayaran/${id}`, 'DELETE');
                handle.fetchAndDisplayJenisPembayaran();
                render.formPembayaran(document.getElementById('form-pembayaran-container'));
            }
        },
        pembayaranSubmit: async (e) => {
            e.preventDefault(); const form = e.target;
            const body = { siswa: form.siswa.value, jenisPembayaran: form.jenisPembayaran.value, jumlahBayar: form.jumlahBayar.value, status: form.status.value, keterangan: form.keterangan.value, };
            if (!body.siswa || !body.jenisPembayaran) { alert('Siswa dan Jenis Pembayaran harus dipilih.'); return; }
            await apiRequest('/api/pembayaran', 'POST', body);
            alert('Pembayaran berhasil dicatat!');
            form.reset();
        }
    };
    async function apiRequest(endpoint, method = 'GET', body = null) {
        const token = localStorage.getItem('token'); if (!token) { logout(); return; }
        const options = { method, headers: { 'Authorization': `Bearer ${token}` } };
        if (body) { options.headers['Content-Type'] = 'application/json'; options.body = JSON.stringify(body); }
        try {
            const response = await fetch(`${API_URL}${endpoint}`, options);
            if(response.status === 401) logout();
            const data = await response.json();
            if (!response.ok) throw new Error(data.message);
            return data;
        } catch (error) { console.error("API Error:", error); alert(error.message); }
    }
    function setupUI() { const ids = ['app-shell','logout-btn','sidebar','user-profile-info','nav-container','main-content','page-title']; ids.forEach(id => { ui[id.replace(/-(\w)/g, (m, p1) => p1.toUpperCase())] = document.getElementById(id); }); }
    function showDashboard() {
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user || user.role !== 'tata_usaha') { logout(); return; }
        ui.appShell.style.display = 'flex';
        renderLayout(user);
    }
    function renderLayout(user) {
        ui.userProfileInfo.innerHTML = `<div class="w-10 h-10 bg-indigo-200 rounded-full flex items-center justify-center font-bold text-indigo-700">${user.name.charAt(0)}</div><div><p class="font-semibold">${user.name}</p><p class="text-sm text-gray-500">${user.role}</p></div>`;
        const navItems = [
            { text: 'Manajemen Pembayaran', icon: 'dollar-sign', handler: () => render.page('Manajemen Pembayaran', render.manajemenPembayaran) },
            { text: 'Riwayat Transaksi', icon: 'history', handler: () => render.page('Riwayat Transaksi', render.riwayatTransaksi) },
        ];
        ui.navContainer.innerHTML = '';
        navItems.forEach((item, index) => {
            const link = document.createElement('a'); link.href = '#';
            link.className = 'nav-link flex items-center px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg';
            if (index === 0) link.classList.add('active');
            link.innerHTML = `<i data-lucide="${item.icon}" class="w-5 h-5 mr-3"></i><span>${item.text}</span>`;
            link.onclick = (e) => { e.preventDefault(); document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); link.classList.add('active'); item.handler(); };
            ui.navContainer.appendChild(link);
        });
        lucide.createIcons();
        if (navItems.length > 0) navItems[0].handler();
    }
    const logout = () => { localStorage.clear(); window.location.href = 'login.html'; };
    document.addEventListener('DOMContentLoaded', () => {
        setupUI();
        const token = localStorage.getItem('token');
        if (!token) { window.location.href = 'login.html'; return; }
        showDashboard();
        ui.logoutBtn.addEventListener('click', logout);
    });
</script>
</body>
</html>
