<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Pimpinan - EduPortal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        #app-shell { display: none; }
        .nav-link.active { background-color: #eef2ff; color: #4f46e5; font-weight: 600; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app-shell" class="hidden h-screen bg-gray-100">
        <!-- Sidebar -->
        <div id="sidebar" class="w-64 bg-white shadow-lg flex-shrink-0 flex flex-col">
            <div class="p-6 border-b"><h1 class="text-2xl font-bold text-indigo-600">EduPortal</h1></div>
            <div class="p-4 border-b"><div id="user-profile-info"></div></div>
            <nav id="nav-container" class="p-4 space-y-2 flex-grow"></nav>
            <div class="p-4 border-t"><button id="logout-btn" class="w-full flex items-center px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg"><i data-lucide="log-out" class="w-5 h-5 mr-3"></i>Logout</button></div>
        </div>
        <!-- Konten Utama -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex justify-between items-center p-4 bg-white border-b"><h2 id="page-title" class="text-xl font-semibold text-gray-800">Dasbor</h2></header>
            <main id="main-content" class="flex-1 overflow-x-hidden overflow-y-auto p-6"></main>
        </div>
    </div>

<script>
    const API_URL = 'http://localhost:5000';
    const ui = {};

    // =================================================================
    // ----------- RENDER FUNCTIONS (Membuat Tampilan) -----------
    // =================================================================
    const render = {
        page: (title, handler) => {
            ui.pageTitle.textContent = title;
            ui.mainContent.innerHTML = `<div id="content-wrapper" class="bg-white p-6 rounded-xl shadow-md min-h-full"></div>`;
            handler(document.getElementById('content-wrapper'));
        },
        pimpinanDashboard: async (container) => {
            container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-lg border"><p class="text-sm text-gray-500">Total Guru</p><p id="summary-guru" class="text-3xl font-bold">...</p></div>
                <div class="bg-white p-6 rounded-lg border"><p class="text-sm text-gray-500">Total Siswa</p><p id="summary-siswa" class="text-3xl font-bold">...</p></div>
                <div class="bg-white p-6 rounded-lg border"><p class="text-sm text-gray-500">Rata-rata Nilai Sekolah</p><p id="summary-nilai" class="text-3xl font-bold">...</p></div>
            </div>`;
            const result = await apiRequest('/api/dashboard/pimpinan');
            if (result && result.ringkasan) {
                document.getElementById('summary-guru').textContent = result.ringkasan.jumlahGuru;
                document.getElementById('summary-siswa').textContent = result.ringkasan.jumlahSiswa;
                document.getElementById('summary-nilai').textContent = result.ringkasan.rataRataNilaiSekolah;
            }
        },
        daftarPengguna: async (container, role) => {
            container.innerHTML = `Memuat data ${role}...`;
            const result = await apiRequest('/api/users');
            if (!result || !result.data) { container.innerHTML = 'Gagal memuat data.'; return; }
            const filteredUsers = result.data.filter(user => user.role === role);
            let tableHTML = `<div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-gray-100"><tr><th class="p-3">Nama</th><th class="p-3">Email</th><th class="p-3">Status</th></tr></thead><tbody>`;
            if (filteredUsers.length > 0) {
                filteredUsers.forEach(user => {
                    tableHTML += `<tr class="border-b"><td class="p-3 font-medium">${user.name}</td><td class="p-3">${user.email}</td><td class="p-3">${user.status}</td></tr>`;
                });
            } else {
                tableHTML += `<tr><td colspan="3" class="p-3 text-center text-gray-500">Tidak ada data ${role}.</td></tr>`;
            }
            tableHTML += '</tbody></table></div>';
            container.innerHTML = tableHTML;
        },
        daftarKelas: async (container) => {
            container.innerHTML = 'Memuat data kelas...';
            const result = await apiRequest('/api/kelas');
            if (!result || !result.data) { container.innerHTML = 'Gagal memuat data.'; return; }
            let content = '';
            result.data.forEach(kelas => {
                const siswaList = kelas.siswa.map(s => s.name).join(', ') || 'Belum ada siswa';
                content += `<div class="p-4 border rounded-lg mb-3">
                    <p class="font-semibold text-lg">${kelas.namaKelas}</p>
                    <p class="text-sm text-gray-600 mb-2">Wali Kelas: ${kelas.waliKelas ? kelas.waliKelas.name : 'N/A'}</p>
                    <div class="mt-2 pt-2 border-t text-sm"><p class="font-medium">Siswa:</p><p class="text-gray-700">${siswaList}</p></div>
                </div>`;
            });
            container.innerHTML = content || '<p>Belum ada kelas yang dibuat.</p>';
        },
    };

    // =================================================================
    // --------------- INISIALISASI & LOGIKA UTAMA ------------------
    // =================================================================
    async function apiRequest(endpoint, method = 'GET', body = null) {
        const token = localStorage.getItem('token'); if (!token) { logout(); return; }
        const options = { method, headers: { 'Authorization': `Bearer ${token}` } };
        if (body) { options.headers['Content-Type'] = 'application/json'; options.body = JSON.stringify(body); }
        try {
            const response = await fetch(`${API_URL}${endpoint}`, options);
            if(response.status === 401) { logout(); return; }
            const data = await response.json();
            if (!response.ok) throw new Error(data.message);
            return data;
        } catch (error) { console.error("API Error:", error); }
    }
    
    function setupUI() {
        const ids = ['app-shell','logout-btn','sidebar','user-profile-info','nav-container','main-content','page-title'];
        ids.forEach(id => { ui[id.replace(/-(\w)/g, (m, p1) => p1.toUpperCase())] = document.getElementById(id); });
    }
    
    function showDashboard() {
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user || user.role !== 'pimpinan') { logout(); return; }
        ui.appShell.style.display = 'flex';
        renderLayout(user);
    }

    function renderLayout(user) {
        ui.userProfileInfo.innerHTML = `<div class="w-10 h-10 bg-indigo-200 rounded-full flex items-center justify-center font-bold text-indigo-700">${user.name.charAt(0)}</div><div><p class="font-semibold">${user.name}</p><p class="text-sm text-gray-500">${user.role}</p></div>`;
        const navItems = [
            { text: 'Dashboard', icon: 'layout-dashboard', handler: () => render.page('Dashboard', render.pimpinanDashboard) },
            { text: 'Daftar Guru', icon: 'user-square', handler: () => render.page('Daftar Guru', c => render.daftarPengguna(c, 'guru')) },
            { text: 'Daftar Siswa', icon: 'users', handler: () => render.page('Daftar Siswa', c => render.daftarPengguna(c, 'siswa')) },
            { text: 'Daftar Kelas', icon: 'clipboard-list', handler: () => render.page('Daftar Kelas', render.daftarKelas) },
        ];
        ui.navContainer.innerHTML = '';
        navItems.forEach((item, index) => {
            const link = document.createElement('a'); link.href = '#';
            link.className = 'nav-link flex items-center px-4 py-3 text-gray-700 hover:bg-gray-100 rounded-lg';
            if (index === 0) link.classList.add('active');
            link.innerHTML = `<i data-lucide="${item.icon}" class="w-5 h-5 mr-3"></i><span>${item.text}</span>`;
            link.onclick = (e) => { e.preventDefault(); document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active')); link.classList.add('active'); item.handler(); };
            ui.navContainer.appendChild(link);
        });
        lucide.createIcons();
        if (navItems.length > 0) navItems[0].handler();
    }

    const logout = () => { localStorage.clear(); window.location.href = 'login.html'; };
    
    document.addEventListener('DOMContentLoaded', () => {
        setupUI();
        const token = localStorage.getItem('token');
        if (!token) { window.location.href = 'login.html'; return; }
        showDashboard();
        ui.logoutBtn.addEventListener('click', logout);
    });
</script>
</body>
</html>
